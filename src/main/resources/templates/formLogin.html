<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head (titulo='Login')}"></head>

<body>
<div class="container-fluid d-flex flex-column vh-100 align-items-center">
    <div class="row flex-grow-1 col-3 align-items-center">
        <form id="loginForm">
            <h2 class="mb-4 text-center">Welcome</h2>

            <!-- Email -->
            <div class="form-group mt-2">
                <label for="email">Email address</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>

            <!-- Password -->
            <div class="form-group mt-3">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>

            <!-- OTP -->
            <div class="form-group mt-3">
                <label for="totpCode">OTP (Google Authenticator)</label>
                <input type="text" class="form-control" id="totpCode" name="totpCode"
                       placeholder="Enter 6-digit code" pattern="[0-9]{6}" maxlength="6" required>
            </div>

            <button type="submit" class="btn btn-primary mt-4 w-100">Login</button>

            <div id="message" class="mt-3 text-center"></div>
        </form>
    </div>
</div>

<div th:replace="~{fragments::bootstrap}"></div>

<script>
document.getElementById("loginForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const totpCode = document.getElementById("totpCode").value.trim();
    const messageDiv = document.getElementById("message");

    messageDiv.className = "mt-3 text-center text-info";
    messageDiv.innerHTML = " Verificando credenciales...";

    try {
        const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, totpCode })
        });

        const text = await response.text();

        if (response.ok) {
            messageDiv.className = "mt-3 text-success text-center";
            messageDiv.innerHTML = " " + text + "<br>Redirigiendo a Home...";
            setTimeout(() => window.location.href = "/dashboard", 1000);
        } else {
            messageDiv.className = "mt-3 text-danger text-center";
            messageDiv.innerHTML = " " + text;
        }
    } catch (error) {
        messageDiv.className = "mt-3 text-danger text-center";
        messageDiv.innerHTML = " Error de conexi√≥n con el servidor";
    }
});
</script>
</body>
</html>
